# Fastfile that is meant to be used by all iOS apps in the organization. 
# This file is meant to be imported into another `Fastfile` so the functions in this file are usable. 
# 
# Import this file in 2 ways:
# 1. Locally (for all Fastfile files in this repository)
# Use "import" from these docs: https://docs.fastlane.tools/advanced/Fastfile/#importing-another-fastfile
#
# 2. Remotely (for all Fastfile files in a git repository not this one)
# Add this to your Fastfile:
# ```
# import_from_git(
#  url: "git@github.com:customerio/customerio-ios.git", # The URL of the repository to import the Fastfile from.
#  branch: "main", # The branch to checkout on the repository.
#  path: "Apps/fastlane/Fastfile" # The path of the Fastfile in the repository.
# )
# ```

# Functions for setting up code signing on CI server 
import_from_git(
  url: "https://github.com/customerio/apple-code-signing.git", 
  branch: "main", 
  path: "fastlane/Fastfile"
)

before_all do |lane, options|    
  setup_ci
end

# Note: I was experiencing issues getting adhoc code signing working for the cocoapods FCM sample app. 
# For now, we just need to test the app compiles so development code signing is good enough for now until we fix the issue.     
# For now, do code signing and app compiling using development type. 
lane :build do |arguments|
  download_ci_code_signing_files

  uses_cocoapods = File.exists?("../Podfile")
  if uses_cocoapods 
    UI.message "Project uses CocoaPods. Going to skip SPM dependency downloading."
  end 

  build_ios_app(
    export_method: "ad-hoc",
    configuration: "Release",
    xcodebuild_formatter: "xcbeautify",
    disable_package_automatic_updates: true, # force SPM dependencies to install from Package.resolved lock file
    skip_package_dependencies_resolution: uses_cocoapods, # If using CocoaPods, skip SPM dependency downloading to save build time
  )
end