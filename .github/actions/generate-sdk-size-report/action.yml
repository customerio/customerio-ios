name: Generate SDK size reports 
# We only need to use 1 sample app build to generate the SDK size diff report. Therefore, we are hard-coding APN-UIKit into this action.
description: Run this action to generate all of the SDK size reports. 

inputs:
  GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64:
    description: 'Maps to the secret, GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64. Used for code signing. See the Fastlane config files to learn more.'
    type: string
    required: true

# 3 separate SDK size reports may be generated by this action. 
outputs:
  sdk-size-report:
    description: 'The SDK size report, as a string.'
    value: ${{ steps.sdk-size-report.outputs.stdout }}
  sdk-size-including-dependencies-report:
    description: 'The SDK size report, as a string. This report includes dependencies as well as the SDK size.'
    value: ${{ steps.sdk-size-including-dependencies-report.outputs.stdout }}
  sdk-size-diff-report:
    description: 'The SDK size report, as a string. This report is the size difference between the current branch code and the last build on main branch. Only populated if this action is run from a pull request.'
    value: ${{ steps.sdk-size-diff-report.outputs.stdout }}

runs:
  using: "composite"
  steps:
  - name: Assert running on macOS runner. Bloaty requires some complex compilation to run on Linux. Therefore, this action only supports macOS runners.
    shell: bash
    run: test $RUNNER_OS = 'macOS'

  - name: Install bloaty, in case it is not already 
    shell: bash
    run: brew install bloaty || true # If it's already installed, this will fail without error    

  - name: Make a build of the sample app to generate report for 
    uses: ./.github/actions/build-sample-app
    id: build-sample-app
    with:
      apn-or-fcm: 'APN'
      sample-app: 'APN-UIKit'
      # Pass in a hard-coded version and build number to ensure that all sample app builds that are compiled for SDK size reports are consistent.
      # When we compare size reports between different builds, we want to ensure that the only difference is the SDK code that was modified in a PR. 
      fastlane-build-args: '{"app_version": "1.0.0", "build_number": "1"}'
      # workspace credentials do not matter since we are not using this app build. 
      customerio-workspace-siteid: "12345"
      customerio-workspace-cdp-api-key: "12345"
      customerio-workspace-name: "Dummy Workspace"
      GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64: ${{ inputs.GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64 }}

  - name: Save the sample app build, if this is a main branch build 
    if: github.ref == 'refs/heads/main'   
    uses: ./.github/actions/main-sample-app-build 
    with:
      set-latest-main-build: ${{ steps.build-sample-app.outputs.app-xcarchive-name }}
      GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64: ${{ inputs.GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64 }}

  - name: Make the SDK size report
    uses: mathiasvr/command-output@v2.0.0
    id: sdk-size-report
    with:
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources).*" \
          -d compileunits --debug-file=${{ steps.build-sample-app.outputs.app-xcarchive-path }}/dSYMs/APN\ UIKit.app.dSYM/Contents/Resources/DWARF/APN\ UIKit \
          ${{ steps.build-sample-app.outputs.app-xcarchive-path }}/Products/Applications/APN\ UIKit.app/APN\ UIKit \
          -n 0 
    
  - name: Make the SDK size report, including dependencies
    uses: mathiasvr/command-output@v2.0.0
    id: sdk-size-including-dependencies-report
    with: 
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources)|(SourcePackages\/checkouts).*" \
          -d compileunits --debug-file=${{ steps.build-sample-app.outputs.app-xcarchive-path }}/dSYMs/APN\ UIKit.app.dSYM/Contents/Resources/DWARF/APN\ UIKit \
          ${{ steps.build-sample-app.outputs.app-xcarchive-path }}/Products/Applications/APN\ UIKit.app/APN\ UIKit \
          -n 0 
  
  # We want to determine if the SDK's binary size will change after merging a PR. 
  # To do that, we take the latest sample app build from the main branch and compare it to the app passed into this action. 

  - name: Download latest main sample app build to generate SDK size diff report       
    if: ${{ github.event_name == 'pull_request' }}
    id: download-latest-main-build
    uses: ./.github/actions/main-sample-app-build
    with:
      GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64: ${{ inputs.GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64 }}

  - name: Generate SDK binary diff report between main branch and current branch 
    if: ${{ steps.download-latest-main-build.outputs.apn-app-xcarchive-path != '' }}
    id: sdk-size-diff-report
    uses: mathiasvr/command-output@v2.0.0
    with: 
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources).*" -d compileunits \
          --debug-file="${{ steps.download-latest-main-build.outputs.apn-app-xcarchive-path }}/dSYMs/APN UIKit.app.dSYM/Contents/Resources/DWARF/APN UIKit" \
          --debug-file="${{ steps.build-sample-app.outputs.app-xcarchive-path }}/dSYMs/APN UIKit.app.dSYM/Contents/Resources/DWARF/APN UIKit" \
          "${{ steps.build-sample-app.outputs.app-xcarchive-path }}/Products/Applications/APN UIKit.app/APN UIKit" -- "${{ steps.download-latest-main-build.outputs.apn-app-xcarchive-path }}/Products/Applications/APN UIKit.app/APN UIKit" 