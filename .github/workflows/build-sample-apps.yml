name: Build sample apps 

on: 
  pull_request: # build sample apps for every commit pushed to an open pull request (including drafts)
  push: 
    branches: [main]
  workflow_dispatch: # allow manual run     

concurrency: # cancel previous workflow run if one exists. 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-pr-comment:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # to be able to comment on PR
    outputs:
      comment-id: ${{ steps.create-comment.outputs.comment-id }}
    steps:
    - name: Find Comment
      uses: peter-evans/find-comment@v3
      id: existing-comment
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: <!-- sample app builds --> 
    
    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@v4
      id: create-comment
      with:
        comment-id: ${{ steps.existing-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          <!-- sample app builds --> 
          # Sample app builds ðŸ“±
          
          Below you will find the list of the latest versions of the sample apps. It's recommended to always download the latest builds of the sample apps to accurately test the pull request. 

          ---
          ${{ steps.build.outputs.build-log }}
        edit-mode: replace # replace the existing comment with new content since we are creating new builds 

  build-sample-apps:
    if: ${{ always() }} # do not skip running this step if update-pr-comment does not run 
    needs: [update-pr-comment] # wait for PR comment to be created saying new builds are being made. 
    permissions:
      pull-requests: write # comment on pull request with build information 
    strategy:
      fail-fast: false # if one sample app fails to build, let the other sample apps continue to build and not cancel them. 
      matrix: # Use a matrix allowing us to build multiple apps in parallel. Just add an entry to the matrix and it will build!
        sample-app: 
        # List all sample apps you want to have compiled. 
        # List item is name of directory inside of "Apps" directory for the corresponding app to compile. 
        - "CocoaPods-FCM"
        - "APN-UIKit"
        include: # Add additional variables to each sample app build: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategymatrixinclude
          - sample-app: "APN-UIKit"
            apn-or-fcm: APN
          - sample-app: "CocoaPods-FCM"
            apn-or-fcm: FCM

    runs-on: macos-14
    name: Building app...${{ matrix.sample-app }}
    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/setup-ios

    - name: Install CLI tools used in CI script 
      run: |
        brew install sd # used in CI script as an easier to use sed CLI. Replaces text in files. 
        brew install xcbeautify # used by fastlane for output 
        brew install bloaty # used to generate SDK binary size reports 
    
    - name: Install tools from Gemfile (ruby language) used for building our apps with 
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true # cache tools to make builds faster in future 
    
    - name: Setup APN build environment to prepare for building
      if: ${{ matrix.apn-or-fcm == 'APN' }}
      run: |
        make setup_sample_app app=${{ matrix.sample-app }}
        sd CUSTOMERIO_WORKSPACE_SITE_ID ${{ secrets.CUSTOMERIO_APN_WORKSPACE_SITE_ID }} "Apps/${{ matrix.sample-app }}/BuildEnvironment.swift"
        sd CUSTOMERIO_WORKSPACE_CDP_API_KEY ${{ secrets.CUSTOMERIO_APN_WORKSPACE_CDP_API_KEY }} "Apps/${{ matrix.sample-app }}/BuildEnvironment.swift"

    - name: Setup FCM build environment to prepare for building
      if: ${{ matrix.apn-or-fcm == 'FCM' }}
      run: |
        make setup_sample_app app=${{ matrix.sample-app }}
        sd CUSTOMERIO_WORKSPACE_SITE_ID ${{ secrets.CUSTOMERIO_FCM_WORKSPACE_SITE_ID }} "Apps/${{ matrix.sample-app }}/BuildEnvironment.swift"
        sd CUSTOMERIO_WORKSPACE_CDP_API_KEY ${{ secrets.CUSTOMERIO_FCM_WORKSPACE_CDP_API_KEY }} "Apps/${{ matrix.sample-app }}/BuildEnvironment.swift"

    - name: Does ${{ matrix.sample-app }} use CocoaPods? 
      id: check_podfile_exists
      uses: andstor/file-existence-action@v3
      with:
        files: "Apps/${{ matrix.sample-app }}/Podfile"

    - name: Cache CocoaPods downloaded dependencies for faster builds in the future 
      if: steps.check_podfile_exists.outputs.files_exists == 'true'
      uses: actions/cache@v4
      with:
        path: "Apps/${{ matrix.sample-app }}/Pods"
        key: ${{ runner.os }}-${{ matrix.sample-app}}-Pods
        restore-keys: |
          ${{ runner.os }}-${{ matrix.sample-app}}-Pods

    - name: Run pod install if using CocoaPods 
      if: steps.check_podfile_exists.outputs.files_exists == 'true'
      run: make install_cocoapods_dependencies app=CocoaPods-FCM

    - name: Dump GitHub Action metadata because Fastlane uses it. Viewing it here helps debug JSON parsing code in Firebase. 
      run: cat $GITHUB_EVENT_PATH

    - name: Build app via Fastlane 
      uses: maierj/fastlane-action@v3.1.0
      with:
        lane: "ios build"
        subdirectory: "Apps/${{ matrix.sample-app }}"
      env: 
        GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64: ${{ secrets.GOOGLE_CLOUD_MATCH_READONLY_SERVICE_ACCOUNT_B64 }}
        FIREBASE_APP_DISTRIBUTION_SERVICE_ACCOUNT_CREDS_B64: ${{ secrets.FIREBASE_APP_DISTRIBUTION_SERVICE_ACCOUNT_CREDS_B64 }}
    
    # xcodebuild creates builds that include a timestamp in the name. In order for bloaty to read the build, we need to rename it to a static name.
    - name: Rename the same app build to a static name that bloaty can understand  
      working-directory: Apps/${{ matrix.sample-app }}/build/
      run: mv *.xcarchive App.xcarchive 
  
    #############
    # Generate SDK size reports for the SDK size at this commit 
    #############         

    # We only need to run bloaty on 1 app. Therefore, we are hard-coding APN-UIKit into these steps below.

    - name: Print the binary size of our SDK in an app, minus dependencies
      if: ${{ matrix.sample-app == 'APN-UIKit' }}
      working-directory: Apps/${{ matrix.sample-app }}/build/
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources).*" \
          -d compileunits --debug-file=App.xcarchive/dSYMs/APN\ UIKit.app.dSYM/Contents/Resources/DWARF/APN\ UIKit \
          App.xcarchive/Products/Applications/APN\ UIKit.app/APN\ UIKit \
          -n 0
    
    - name: Print the binary size of our SDK in an app, including dependencies
      if: ${{ matrix.sample-app == 'APN-UIKit' }}
      working-directory: Apps/${{ matrix.sample-app }}/build/
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources)|(SourcePackages\/checkouts).*" \
          -d compileunits --debug-file=App.xcarchive/dSYMs/APN\ UIKit.app.dSYM/Contents/Resources/DWARF/APN\ UIKit \
          App.xcarchive/Products/Applications/APN\ UIKit.app/APN\ UIKit \
          -n 0

    #############
    #  Cache main builds for later use
    #############

    # If we are on the main branch, we want to cache the sample app build (.xcarchive directory) for later use.
    # The main branch contains the latest version of our code. So, it's the new baseline that we compare all PRs against. 
    # By saving the sample app build, we can perform comparisons such as binary size changes between the main branch and the PR branch.    

    - name: Prepare the sample app build to be cached, if this is a main branch build
      if: github.ref == 'refs/heads/main' 
      working-directory: Apps/${{ matrix.sample-app }}/build/
      run: |
        mv App.xcarchive MainBranchApp.xcarchive # Rename the app build to identify it and re-use it later. 

    - name: Cache the sample app build, if this is a main branch build 
      if: github.ref == 'refs/heads/main'   
      uses: actions/cache/save@v4
      with:
        # the key must be unique. caches are immutable so the key must always be unique. 
        # https://github.com/actions/cache/blob/main/tips-and-workarounds.md#update-a-cache
        key: ${{ matrix.sample-app }}-build-main-${{ github.run_id }}
        path: Apps/${{ matrix.sample-app }}/build/MainBranchApp.xcarchive

    - name: Update sample builds PR comment with build information 
      if: ${{ github.event_name == 'pull_request' }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ needs.update-pr-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        # the variables APP_BUILD_NUMBER, APP_VERSION_STRING are created when fastlane runs "build". 
        body: |
          * ${{ matrix.sample-app }}: `${{ env.APP_VERSION_STRING }} (${{ env.APP_BUILD_NUMBER }})`
        edit-mode: append # append new line to the existing PR comment to build a list of all sample app builds. 

    - name: Update sample builds PR comment with build failure message 
      if: ${{ failure() }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ needs.update-pr-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          * ${{ matrix.sample-app }}: Build failed. See [CI job logs](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}) to determine the issue and try re-building. 
        edit-mode: append # append new line to the existing PR comment to build a list of all sample app builds. 

    #############
    # Generate SDK size diff report between main branch and PR
    #############    

    # We want to determine if the SDK's binary size will change after merging the PR. 
    # To do that, we take the latest sample app build from the main branch and the PR branch and compare the SDK sizes between them. 
    # 
    # Note: We only need to use 1 sample app build to generate the SDK size diff report. Therefore, we are hard-coding APN-UIKit into these steps below. 

    - name: Download latest main sample app build to generate SDK size diff report 
      if: github.event_name == 'pull_request' && matrix.sample-app == 'APN-UIKit'
      uses: actions/cache/restore@v4
      with:
        # key param is required for this action to run, but the value has no effect. Therefore, the value is a placeholder value. 
        # The restore-keys param is what will download the latest cache version for us.
        key: ThisWillNotMatchAnything-ButValueIsRequiredHere
        path: Apps/${{ matrix.sample-app }}/build/MainBranchApp.xcarchive
        # The restore key is what will download the latest cache entry for us. 
        # 
        # "If there are multiple partial matches for a restore key, the action returns the most recently created cache."
        # https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#matching-a-cache-key
        restore-keys: |
          ${{ matrix.sample-app }}-build-main-

    - name: Generate SDK binary diff report between main branch and PR
      if: github.event_name == 'pull_request' && matrix.sample-app == 'APN-UIKit'      
      working-directory: Apps/${{ matrix.sample-app }}/build/
      run: |
        bloaty --source-filter ".*(customerio-ios\/Sources).*" -d compileunits \
          --debug-file="MainBranchApp.xcarchive/dSYMs/APN UIKit.app.dSYM/Contents/Resources/DWARF/APN UIKit" \
          --debug-file="App.xcarchive/dSYMs/APN UIKit.app.dSYM/Contents/Resources/DWARF/APN UIKit" \
          "App.xcarchive/Products/Applications/APN UIKit.app/APN UIKit" -- "MainBranchApp.xcarchive/Products/Applications/APN UIKit.app/APN UIKit"
  
