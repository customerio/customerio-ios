name: Test deployment 

# This workflow gets triggered by another workflow. 
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number associated with this test deployment'
        required: true 
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  semantic-release-dry-run:    
    runs-on: ubuntu-latest
    name: Dry run deployment
    permissions: # permissions must match that of a real deployment because auth is tested in dry-run
      contents: write # for pushing commits and tags 
      issues: write # comment on github issues 
      pull-requests: write # comment and interact with PRs. 
    steps:
    - uses: actions/checkout@v3

    - name: Get GitHub URL linking to this CI run so we can reference later 
      uses: Tiryoh/gha-jobid-action@v0.1.2
      id: current-job
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        job_name: semantic-release-dry-run

    - name: Get branch names to use later
      id: branch-name
      uses: tj-actions/branch-names@v6

    - name: âœï¸ Post comment on PR ${{ inputs.pr_number }} saying simulated deploy has begun 
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        number: ${{ inputs.pr_number }}
        message: |
          Simulating a deployment after this PR gets merged...this comment will be updated after the testing has been completed...

    - name: ğŸš€ Run simulated deployment ğŸš€ - View logs of this step to see results of deployment
      uses: cycjimmy/semantic-release-action@v3
      id: semantic-release
      with: 
        semantic_version: 18 # version numbers below can be in many forms: M, M.m, M.m.p
        dry_run: true # Critical. If we do not do this, an actual deployment will happen. 
        extra_plugins: |
          conventional-changelog-conventionalcommits@4
          @semantic-release/changelog@6
          @semantic-release/git@10
          @semantic-release/github@8
          @semantic-release/exec@6
        branches: |
          [
            '${{ steps.branch-name.outputs.current_branch }}'
          ]
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âœï¸ Update PR ${{ inputs.pr_number }} comment with message that a deployment will happen if PR is merged
      uses: marocchino/sticky-pull-request-comment@v2
      if: ${{ steps.semantic-release.outputs.new_release_published == 'true' }}
      with:
        number: ${{ inputs.pr_number }}
        message: |
          ## Simulated deployment results      

          ### If this pull request gets merged, ğŸš¢ **a new release will be made** ğŸš¢. 

          * New version: **${{ steps.semantic-release.outputs.new_release_version }}**
          * Previous version: **${{ steps.semantic-release.outputs.last_release_version }}**
          * Release notes: ${{ steps.semantic-release.outputs.new_release_notes }}

          Is this not what you expected? Try these suggestions:
          1. 1. [Modify the title of this pull request](https://www.conventionalcommits.org). Only pull requests prefixed with `feat:` and `fix:` trigger a deployment
          2. View the [CI server logs](${{ steps.current-job.outputs.html_url }}) to view the logs of the deployment simulation. Use these logs to better understand why a deployment would not trigger. 

    - name: âœï¸ Update PR ${{ inputs.pr_number }} comment with message that a deployment will not happen if PR is merged
      uses: marocchino/sticky-pull-request-comment@v2
      if: ${{ steps.semantic-release.outputs.new_release_published == 'false' }}
      with:
        number: ${{ inputs.pr_number }}
        message: |
          ## Simulated deployment results

          ### If this pull request gets merged, **a new release will ğŸ™…â€â™€ï¸ *not* ğŸ™…â€â™€ï¸ be made**

          Is this not what you expected? Try these suggestions:
          1. 1. [Modify the title of this pull request](https://www.conventionalcommits.org). Only pull requests prefixed with `feat:` and `fix:` trigger a deployment
          2. View the [CI server logs](${{ steps.current-job.outputs.html_url }}) to view the logs of the deployment simulation. Use these logs to better understand why a deployment would not trigger. 
    
    - name: âœï¸ Update PR ${{ inputs.pr_number }} comment with message that the simulated deployment failed to execute
      uses: marocchino/sticky-pull-request-comment@v2
      if: ${{ failure() }}
      with:
        number: ${{ inputs.pr_number }}
        message: |
          ## Simulated deployment encountered a failure âš ï¸
          
          This could mean that there is an issue with the deployment configuration. 

          It's suggested that you [view the CI server logs](${{ steps.current-job.outputs.html_url }}) to see what went wrong and fix the issue before merging the PR. Push more commits to this branch to run the simulated deployment again. 
  
  delete-branch:
    needs: semantic-release-dry-run
    name: Delete branch after no longer need it 
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to delete branch
    steps:
      - uses: actions/checkout@v3
      - name: Get branch names to use later
        id: branch-name
        uses: tj-actions/branch-names@v6
      - run: git push origin --delete ${{ steps.branch-name.outputs.current_branch }}

